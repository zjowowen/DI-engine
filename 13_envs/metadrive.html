


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Metadrive &mdash; DI-engine 0.1.0 documentation</title>
  

  <link rel="shortcut icon" href="../_static/images/favicon.ico" />
  
  

  

  
  
  

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/style.css" type="text/css" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="next" title="Specification" href="../20_spec/index.html" />
  <link rel="prev" title="Evogym" href="evogym.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">


  
  <script src="../_static/js/modernizr.min.js"></script>
  <script>
    MathJax = {
        chtml: {
            scale: 1,
            minScale: 1,
        },
        svg: {
            scale: 1,
            minScale: 1,
        }
    }
</script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
    integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://di-engine-docs.readthedocs.io/en/latest/"
        aria-label="OpenMMLab"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://github.com/opendilab/DI-engine" target="_blank">GitHub</a>
          </li>
          <li >
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a
                class="resource-option with-down-arrow">
                OpenDILab
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/DI-engine" target="_blank">
                  <span class="dropdown-title">DI-engine </span>
                  <p>OpenDILab Decision AI Engine</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/DI-star" target="_blank">
                  <span class="dropdown-title">DI-star </span>
                  <p>OpenDILab Decision AI in StarCraftII</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/DI-drive" target="_blank">
                  <span class="dropdown-title">DI-drive </span>
                  <p>OpenDILab Auto-driving platform</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/GoBigger" target="_blank">
                  <span class="dropdown-title">GoBigger </span>
                  <p>OpenDILab Multi-Agent Environment</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/DI-smartcross" target="_blank">
                  <span class="dropdown-title">DI-smartcross </span>
                  <p>Decision Intelligence Platform for Traffic Crossing Signal Control</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/DI-treetensor" target="_blank">
                  <span class="dropdown-title">DI-treetensor </span>
                  <p>Tree Nested PyTorch Tensor Lib</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/DI-sheep" target="_blank">
                  <span class="dropdown-title">DI-sheep </span>
                  <p>Deep Reinforcement Learning + 3 Tiles Game</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/awesome-model-based-RL" target="_blank">
                  <span class="dropdown-title">awesome-model-based-RL </span>
                  <p>A curated list of awesome model based RL resources (continually updated)</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/awesome-decision-transformer" target="_blank">
                  <span class="dropdown-title">awesome-decision-transformer </span>
                  <p>A curated list of Decision Transformer resources (continually updated)</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/awesome-exploration-rl" target="_blank">
                  <span class="dropdown-title">awesome-exploration-rl </span>
                  <p>A curated list of awesome exploration RL resources (continually updated)</p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item"
                  href="https://github.com/opendilab/awesome-multi-modal-reinforcement-learning" target="_blank">
                  <span class="dropdown-title">awesome-multi-modal-reinforcement-learning </span>
                  <p>A curated list of Multi-Modal Reinforcement Learning resources (continually updated)</p>
                </a>
              </div>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

  

  <div class="table-of-contents-link-wrapper">
    <span>Table of Contents</span>
    <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
  </div>

  <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
    <div class="pytorch-side-scroll">
      <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <div class="pytorch-left-menu-search">
          

          
          
          
          

          



<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        
        
        
        
        
        <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../00_intro/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_quickstart/index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_algo/index.html">RL Algorithm Taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_system/index.html">System Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_best_practice/index.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06_faq/index.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reinforcement Learning Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../10_concepts/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_dizoo/index.html">Learn From DI-zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12_policies/index.html">RL Algorithms Cheat Sheet</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">RL Env Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Specification</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../20_spec/index.html">Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../21_code_style/index.html">Code Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../22_test/index.html">Unit Test Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../23_visual/index.html">Diagrams and Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../24_cooperation/index.html">Github Cooperation</a></li>
</ul>

        
        
      </div>
    </div>
  </nav>

  <div class="pytorch-container">
    <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
      <div class="pytorch-breadcrumbs-wrapper">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
            Docs
        </a> &gt;
      </li>

        
          <li><a href="index.html">RL Env Examples</a> &gt;</li>
        
      <li>Metadrive</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/13_envs/metadrive.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
      </div>

      <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
        Shortcuts
      </div>
    </div>

    <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
      <div class="pytorch-content-left">
        
          <div class="rst-content">
            
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
              <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
                
  <section id="metadrive">
<h1>Metadrive<a class="headerlink" href="#metadrive" title="Permalink to this headline">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://metadrive-simulator.readthedocs.io/en/latest/index.html">MetaDrive Env</a> is an efficient compositional driving simulator. The goal of the environment is to control a car (or multiple vehicles) from the starting point to the finishing point safely and on time. It has the following properties:</p>
<ul class="simple">
<li><p>Compositional: It supports the generation of (theoretically infinite) scenarios with various road maps and traffic settings, which can be used in the study of RL generalization.</p></li>
<li><p>Lightweight: easy to install and operate. It can run up to 300 FPS on a standard PC.</p></li>
<li><p>High fidelity: Accurate physics simulations and multiple types of inputs, including lidar, RGB images, top-down semantic maps, and first-person imagery. Users can freely choose the type of observation. The following image introduces an example of observation.</p></li>
</ul>
<img alt="../_images/metadrive.gif" class="align-center" src="../_images/metadrive.gif" />
</section>
<section id="install">
<h2>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h2>
<section id="installation-method">
<h3>Installation Method<a class="headerlink" href="#installation-method" title="Permalink to this headline">¶</a></h3>
<p>Users can choose to install it with one click through pip, or install it from source.</p>
<p>Note: If the user does not have root privileges, please add <code class="docutils literal notranslate"><span class="pre">--user</span></code> after the install command.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install Directly</span>
pip<span class="w"> </span>install<span class="w"> </span>metadrive-simulator

<span class="c1"># Install from source code</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/metadriverse/metadrive.git
<span class="nb">cd</span><span class="w"> </span>metadrive
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</pre></div>
</div>
</section>
<section id="verify-installation">
<h3>Verify Installation<a class="headerlink" href="#verify-installation" title="Permalink to this headline">¶</a></h3>
<p>After the installation is complete, you can verify that the installation was successful by running the following command on the Python command line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">metadrive</span> <span class="kn">import</span> <span class="n">MetaDriveEnv</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">MetadriveEnv</span><span class="p">()</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># output (259,)</span>
</pre></div>
</div>
</section>
<section id="image">
<h3>Image<a class="headerlink" href="#image" title="Permalink to this headline">¶</a></h3>
<p>The image of DI-engine is equipped with the framework itself, which can be obtained by <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">opendilab/ding:nightly</span></code> ,
or by visiting <a class="reference external" href="https://hub.docker.com/r/opendilab/ding">docker hub</a> for more images. Currently, MetaDrive doesn’t have a own image.</p>
</section>
</section>
<section id="space-before-transformation-original-environment">
<h2>Space before Transformation (Original Environment)<a class="headerlink" href="#space-before-transformation-original-environment" title="Permalink to this headline">¶</a></h2>
<p>For details, please refer to the code implementation of <a class="reference external" href="https://github.com/metadriverse/metadrive/blob/main/metadrive/envs/metadrive_env.py">MetaDrive</a> .</p>
<section id="observation-space">
<h3>Observation space<a class="headerlink" href="#observation-space" title="Permalink to this headline">¶</a></h3>
<p>The observation space of the vehicle is a 259-dimensional numpy array, the data type is float32, and the obs shape is (259,). The observation space consists of the following three parts:</p>
<ul class="simple">
<li><p>ego_state : The current state, such as heading, steering, speed and relative distance to the boundary.</p></li>
<li><p>navigation: Navigation information that guides the vehicle to the destination passing through checkpoints.</p></li>
<li><p>surrounding: The surrounding information is generated by lidar, usually using 240 lasers to scan the adjacent area with a radius of 50 meters.</p></li>
</ul>
</section>
<section id="action-space">
<h3>Action space<a class="headerlink" href="#action-space" title="Permalink to this headline">¶</a></h3>
<p>The action space of the MetaDrive environment is a 2-dimensional continuous action, and its valid range is [-1, 1]. Through this design, the action space of each agent is fixed as gym.spaces.Box(low=-1.0, high=1.0, shape=(2, )).</p>
<ul class="simple">
<li><p>The first dimension represents the steering angle. When the action is 1 or -1, it means that the steering wheel is turned to the left or right to the maximum steering angle, and when it is 0, it means that the steering wheel is facing straight ahead.</p></li>
<li><p>The second dimension represents acceleration or braking. When the range is in the (0,1) interval, it means acceleration, and when the range is in (-1,0), it means braking; when it is 0, it means no action is taken.</p></li>
<li><p>At the same time, it also provides a configuration called extra_action_dim (int). For example, if we set config[“extra_action_dim”] = 1, then the action space of each agent will become Box(-1.0, 1.0, shape =(3, )). This allows users to write environment wrappers that introduce more dimensions of input operations.</p></li>
</ul>
</section>
<section id="reward-space">
<h3>Reward space<a class="headerlink" href="#reward-space" title="Permalink to this headline">¶</a></h3>
<p>The default reward function in MetaDrive consists of a dense (obtained during driving) reward and a sparse final reward.</p>
<ul class="simple">
<li><p>Dense Reward: Reflects the degree of longitudinal motion of the vehicle towards the destination in Frenet coordinates at each step.</p></li>
<li><p>Terminal Reward: Only obtained when the vehicle successfully reaches the destination. The details are described in termination_reward below.</p></li>
</ul>
<p>MetaDrive provides a complex reward function. We can customize the reward function from the config dict. The complete reward function consists of the following four parts:</p>
<ul class="simple">
<li><p>Driving reward (driving_reward): From t-1 to t time, the longitudinal distance along the current lane line. It is a dense reward.</p></li>
<li><p>Speed reward (speed_reward): The speed at the current moment. The greater the speed, the greater the reward, it is also a dense reward.</p></li>
<li><p>Lateral scale (use_lateral_reward): It provides a multiplier in the range [0, 1] indicating whether the ego vehicle is far from the center of the current lane, used in conjunction with the driving reward. If True, the size of the driving reward depends not only on the longitudinal distance, but also on the distance between the car and the middle of the lane line.</p></li>
<li><p>Terminal Reward (termination_reward): At the end of an episode, other dense rewards will be disabled and a final reward will be returned depending on the state of the vehicle. The specific situations can be divided into:</p>
<ul>
<li><p>Reaching the destination: the vehicle gets a reward for successfully completing the goal (success_reward);</p></li>
<li><p>Going off the road: the vehicle gets a corresponding penalty (out_of_road_penalty);</p></li>
<li><p>Crash into another car: The vehicle gets a corresponding penalty (crash_vehicle_penalty);</p></li>
<li><p>Crashing into an obstacle: The vehicle gets a corresponding penalty (crash_object_penalty).</p></li>
</ul>
</li>
</ul>
</section>
<section id="other">
<h3>Other<a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h3>
<p>An episode ends if:</p>
<ul class="simple">
<li><p>The vehicle has successfully reached the destination;</p></li>
<li><p>The vehicle crashed into other vehicles or obstacles;</p></li>
<li><p>The vehicle got off the road.</p></li>
</ul>
<p>Randomness:</p>
<ul class="simple">
<li><p>Randomness at the initial moment: The vehicle will be randomly initialized to a certain lane line of a road.</p></li>
<li><p>Randomness of the road: Depending on the random seed, the number of lane lines, the splicing of different modules of the road, and the choice of the end point will vary.</p></li>
</ul>
</section>
</section>
<section id="transformed-space-rl-environment">
<h2>Transformed space (RL environment)<a class="headerlink" href="#transformed-space-rl-environment" title="Permalink to this headline">¶</a></h2>
<section id="id2">
<h3>Observation space<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Different from the original version, the observation space is described as a 259-dimensional vector. In DI-engine,
the observation space of the car is defined as a top view with a size of 5x84x84, where 5 represents the number of channels, and the last two dimensions (84x84) represent the size of the image for each channel.
The semantics of the five channels are:</p>
<ul class="simple">
<li><p>Road and Navigation;</p></li>
<li><p>Own position and own historical position (Ego now and previous pos);</p></li>
<li><p>Top view of surrounding vehicles at time t (Neighbor at step t);</p></li>
<li><p>Top view of surrounding vehicles at time t-1 (Neighbor at step t-1);</p></li>
<li><p>Top view of surrounding vehicles at step t-2 (Neighbor at step t-2).</p></li>
</ul>
<dl>
<dt>In the figure below, a driving scene is given as an example. The red vehicle is the agent we control. It is performing a left turn and interacting with two adjacent blue vehicles.</dt><dd><img alt="../_images/metadrive_figure.png" class="align-center" src="../_images/metadrive_figure.png" />
</dd>
<dt>In the current scenario, the observation of the vehicle can be represented by the following five pictures.</dt><dd><img alt="../_images/metadrive_bird_view.png" class="align-center" src="../_images/metadrive_bird_view.png" />
</dd>
</dl>
</section>
<section id="id3">
<h3>Action Space<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>no change</p></li>
</ul>
</section>
<section id="id4">
<h3>Reward Space<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>no change</p></li>
</ul>
</section>
<section id="id5">
<h3>Other<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">info</span></code> returned by the environment <code class="docutils literal notranslate"><span class="pre">step</span></code> method must contain the <code class="docutils literal notranslate"><span class="pre">eval_episode_return</span></code> key-value pair, which represents the evaluation index of the entire episode, and is the cumulative sum of the rewards of the entire episode in MetaDrive.</p></li>
</ul>
</section>
</section>
<section id="id6">
<h2>Other<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<section id="lazy-initialization">
<h3>Lazy Initialization<a class="headerlink" href="#lazy-initialization" title="Permalink to this headline">¶</a></h3>
<p>In order to support parallel operations such as environment vectorization, the specific environment instance generally adopts the lazy initialization method, that is, the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of the environment does not initialize the real original environment instance, but only sets relevant parameters and configuration values.
Instead, the concrete original environment instance is initialized when the <code class="docutils literal notranslate"><span class="pre">reset</span></code> method is called for the first time.</p>
</section>
<section id="random-seed">
<h3>Random Seed<a class="headerlink" href="#random-seed" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>You can use the _reset_global_seed method to set the random seed of the environment. If you do not set it manually, the environment will randomly sample the random seed setting environment.</p></li>
</ul>
</section>
<section id="the-difference-between-training-and-testing-environments">
<h3>The difference between training and testing environments<a class="headerlink" href="#the-difference-between-training-and-testing-environments" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The training environment uses a dynamic random seed, that is, the random seed of each episode is different and is generated by a random number generator, but the seed of this random number generator is fixed by the <code class="docutils literal notranslate"><span class="pre">seed</span></code> method of the environment .</p></li>
<li><p>The test environment uses a static random seed, that is, the random seed of each episode is the same, and is specified by the <code class="docutils literal notranslate"><span class="pre">seed</span></code> method.</p></li>
</ul>
</section>
</section>
<section id="di-zoo-runnable-code">
<h2>DI-zoo runnable code<a class="headerlink" href="#di-zoo-runnable-code" title="Permalink to this headline">¶</a></h2>
<p>The training configuration files of each algorithm in this environment are in the directory <a class="reference external" href="https://github.com/opendilab/DI-engine/blob/main/dizoo/metadrive/config/">github
link</a>.
Here, for a specific configuration file, such as <code class="docutils literal notranslate"><span class="pre">metadrive_onppo_config.py</span></code> , use the following demo to run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">easydict</span> <span class="kn">import</span> <span class="n">EasyDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">tensorboardX</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>
<span class="kn">import</span> <span class="nn">metadrive</span>
<span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">from</span> <span class="nn">ding.envs</span> <span class="kn">import</span> <span class="n">BaseEnvManager</span><span class="p">,</span> <span class="n">SyncSubprocessEnvManager</span>
<span class="kn">from</span> <span class="nn">ding.config</span> <span class="kn">import</span> <span class="n">compile_config</span>
<span class="kn">from</span> <span class="nn">ding.model.template</span> <span class="kn">import</span> <span class="n">QAC</span><span class="p">,</span> <span class="n">VAC</span>
<span class="kn">from</span> <span class="nn">ding.policy</span> <span class="kn">import</span> <span class="n">PPOPolicy</span>
<span class="kn">from</span> <span class="nn">ding.worker</span> <span class="kn">import</span> <span class="n">SampleSerialCollector</span><span class="p">,</span> <span class="n">InteractionSerialEvaluator</span><span class="p">,</span> <span class="n">BaseLearner</span>
<span class="kn">from</span> <span class="nn">dizoo.metadrive.env.drive_env</span> <span class="kn">import</span> <span class="n">MetaDrivePPOOriginEnv</span>
<span class="kn">from</span> <span class="nn">dizoo.metadrive.env.drive_wrapper</span> <span class="kn">import</span> <span class="n">DriveEnvWrapper</span>

<span class="n">metadrive_basic_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">exp_name</span><span class="o">=</span><span class="s1">&#39;metadrive_onppo_seed0&#39;</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">metadrive</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">use_render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">traffic_density</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span>
            <span class="nb">map</span><span class="o">=</span><span class="s1">&#39;XSOS&#39;</span><span class="p">,</span>
            <span class="n">horizon</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
            <span class="n">driving_reward</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">speed_reward</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">use_lateral_reward</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">out_of_road_penalty</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span>
            <span class="n">crash_vehicle_penalty</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span>
            <span class="n">decision_repeat</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">out_of_route_done</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">manager</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">shared_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">max_retry</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">n_evaluator_episode</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">stop_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">collector_env_num</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">evaluator_env_num</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">action_space</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">obs_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">],</span>
            <span class="n">action_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">action_space</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">,</span>
            <span class="n">bound_type</span><span class="o">=</span><span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
            <span class="n">encoder_hidden_size_list</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">learn</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">epoch_per_collect</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">,</span>
            <span class="n">entropy_weight</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">value_weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">clip_ratio</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
            <span class="n">adv_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">value_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">grad_clip_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">collect</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_sample</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="p">),</span>
        <span class="nb">eval</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">evaluator</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">eval_freq</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="p">),</span> <span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">main_config</span> <span class="o">=</span> <span class="n">EasyDict</span><span class="p">(</span><span class="n">metadrive_basic_config</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">wrapped_env</span><span class="p">(</span><span class="n">env_cfg</span><span class="p">,</span> <span class="n">wrapper_cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DriveEnvWrapper</span><span class="p">(</span><span class="n">MetaDrivePPOOriginEnv</span><span class="p">(</span><span class="n">env_cfg</span><span class="p">),</span> <span class="n">wrapper_cfg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">compile_config</span><span class="p">(</span>
        <span class="n">cfg</span><span class="p">,</span> <span class="n">SyncSubprocessEnvManager</span><span class="p">,</span> <span class="n">PPOPolicy</span><span class="p">,</span> <span class="n">BaseLearner</span><span class="p">,</span> <span class="n">SampleSerialCollector</span><span class="p">,</span> <span class="n">InteractionSerialEvaluator</span>
    <span class="p">)</span>
    <span class="n">collector_env_num</span><span class="p">,</span> <span class="n">evaluator_env_num</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">collector_env_num</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">evaluator_env_num</span>
    <span class="n">collector_env</span> <span class="o">=</span> <span class="n">SyncSubprocessEnvManager</span><span class="p">(</span>
        <span class="n">env_fn</span><span class="o">=</span><span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="n">wrapped_env</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">metadrive</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">collector_env_num</span><span class="p">)],</span>
        <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">manager</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">evaluator_env</span> <span class="o">=</span> <span class="n">SyncSubprocessEnvManager</span><span class="p">(</span>
        <span class="n">env_fn</span><span class="o">=</span><span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="n">wrapped_env</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">metadrive</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">evaluator_env_num</span><span class="p">)],</span>
        <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">manager</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">VAC</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">PPOPolicy</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">tb_logger</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">(</span><span class="s1">&#39;./log/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">exp_name</span><span class="p">))</span>
    <span class="n">learner</span> <span class="o">=</span> <span class="n">BaseLearner</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">learner</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">learn_mode</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="n">exp_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">exp_name</span><span class="p">)</span>
    <span class="n">collector</span> <span class="o">=</span> <span class="n">SampleSerialCollector</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">collector</span><span class="p">,</span> <span class="n">collector_env</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">collect_mode</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="n">exp_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">exp_name</span>
    <span class="p">)</span>
    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">InteractionSerialEvaluator</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">eval</span><span class="o">.</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">evaluator_env</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="n">eval_mode</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="n">exp_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">exp_name</span>
    <span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;before_run&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">should_eval</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">):</span>
            <span class="n">stop</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">learner</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">,</span> <span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">,</span> <span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># Sampling data from environments</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">collect</span><span class="o">.</span><span class="n">n_sample</span><span class="p">,</span> <span class="n">train_iter</span><span class="o">=</span><span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;after_run&#39;</span><span class="p">)</span>
    <span class="n">collector</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">evaluator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">learner</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">main_config</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="benchmark-algorithm-performance">
<h2>Benchmark Algorithm Performance<a class="headerlink" href="#benchmark-algorithm-performance" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>MetaDrive (the average episode return of the test episodes is greater than or equal to 250, which is regarded as the algorithm converges to an approximate optimal value).</p>
<ul class="simple">
<li><p>MetaDrive + PPO</p></li>
</ul>
<img alt="../_images/metadrive_train1.png" class="align-center" src="../_images/metadrive_train1.png" />
</li>
</ul>
</section>
</section>


              </article>
              
            </div>
            <footer>
  
  <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
    
    <a href="../20_spec/index.html" class="btn btn-neutral float-right" title="Specification" accesskey="n"
      rel="next">Next <img src="../_static/images/chevron-right-blue.svg"
        class="next-page"></a>
    
    
    <a href="evogym.html" class="btn btn-neutral" title="Evogym" accesskey="p"
      rel="prev"><img src="../_static/images/chevron-right-blue.svg" class="previous-page"> Previous</a>
    
  </div>
  

  <hr>

  <div role="contentinfo">
    <p>
      &copy; Copyright 2021, OpenDILab Contributors.

    </p>
  </div>
  
  <div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a
      href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the
      Docs</a>.
  </div>
   

</footer>
          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Metadrive</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#install">Install</a><ul>
<li><a class="reference internal" href="#installation-method">Installation Method</a></li>
<li><a class="reference internal" href="#verify-installation">Verify Installation</a></li>
<li><a class="reference internal" href="#image">Image</a></li>
</ul>
</li>
<li><a class="reference internal" href="#space-before-transformation-original-environment">Space before Transformation (Original Environment)</a><ul>
<li><a class="reference internal" href="#observation-space">Observation space</a></li>
<li><a class="reference internal" href="#action-space">Action space</a></li>
<li><a class="reference internal" href="#reward-space">Reward space</a></li>
<li><a class="reference internal" href="#other">Other</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transformed-space-rl-environment">Transformed space (RL environment)</a><ul>
<li><a class="reference internal" href="#id2">Observation space</a></li>
<li><a class="reference internal" href="#id3">Action Space</a></li>
<li><a class="reference internal" href="#id4">Reward Space</a></li>
<li><a class="reference internal" href="#id5">Other</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">Other</a><ul>
<li><a class="reference internal" href="#lazy-initialization">Lazy Initialization</a></li>
<li><a class="reference internal" href="#random-seed">Random Seed</a></li>
<li><a class="reference internal" href="#the-difference-between-training-and-testing-environments">The difference between training and testing environments</a></li>
</ul>
</li>
<li><a class="reference internal" href="#di-zoo-runnable-code">DI-zoo runnable code</a></li>
<li><a class="reference internal" href="#benchmark-algorithm-performance">Benchmark Algorithm Performance</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
    </section>
  </div>

  


  

  
  <script type="text/javascript" id="documentation_options" data-url_root="../"
    src="../_static/documentation_options.js"></script>
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
  <script src="../_static/jquery.js"></script>
  <script src="../_static/underscore.js"></script>
  <script src="../_static/doctools.js"></script>
  

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
  </div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://di-engine-docs.readthedocs.io/en/latest/" aria-label="OpenMMLab"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://github.com/opendilab/DI-engine" target="_blank">GitHub</a>
          </li>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function (e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>

</html>