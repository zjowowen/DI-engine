

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Env Overview &mdash; DI-engine 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Collector Overview" href="collector_overview_zh.html" />
    <link rel="prev" title="Algorithm Overview" href="algorithm_overview_zh.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index_zh.html" class="icon icon-home"> DI-engine
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">使用者指南</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index_zh.html">安装说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index_zh.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index_zh.html">强化学习基础概念介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index_zh.html">强化学习算法攻略合集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_tutorial/index_zh.html">强化学习环境示例手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed/index_zh.html">分布式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../best_practice/index_zh.html">最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index_zh.html">FAQ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index_zh.html">特性介绍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="algorithm_overview_zh.html">Algorithm Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Env Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#baseenv">BaseEnv</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="collector_overview_zh.html">Collector Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_manager_overview_zh.html">Env Manager Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="learner_overview_zh.html">Learner Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="wrapper_hook_overview_zh.html">Wrapper &amp; Hook Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="hpc_rl_overview_zh.html">HPC_RL Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="interaction_overview_zh.html">Interaction模块介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="autolog_overview_zh.html">Autolog模块介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="loader_overview_zh.html">Loader模块介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataloader_overview_zh.html">DataLoader Overview</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发者指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index_zh.html">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specification/index_zh.html">中间件（middleware）编写规范</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index_zh.html">DI-engine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index_zh.html">Docs</a> &raquo;</li>
        
          <li><a href="index_zh.html">特性介绍</a> &raquo;</li>
        
      <li>Env Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/feature/env_overview_zh.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="env-overview">
<h1>Env Overview<a class="headerlink" href="#env-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="baseenv">
<h2>BaseEnv<a class="headerlink" href="#baseenv" title="Permalink to this headline">¶</a></h2>
<p>(ding/envs/env/base_env.py)</p>
<dl>
<dt>概述：</dt><dd><p>环境模块，是强化学习中重要的模块之一。在一些常见的强化学习任务中，例如 <a class="reference external" href="https://gym.openai.com/envs/#atari">atari</a> 相关任务，<a class="reference external" href="https://gym.openai.com/envs/#mujoco">mujoco</a> 相关任务，我们所训练的智能体就是在这样的环境中去进行探索和学习。通常，定义一个环境需要从环境的输入输出入手，并充分考虑其中可能的 <code class="docutils literal notranslate"><span class="pre">observation</span> <span class="pre">space</span></code> 与 <code class="docutils literal notranslate"><span class="pre">action</span> <span class="pre">space</span></code>。OpenAI 所出品的 <cite>gym</cite> 模块已经帮我们定义了绝大多数常用的学术环境。<cite>DI-engine</cite> 也遵循 <cite>gym.Env</cite> 的定义，并在其基础上增加了一系列更为方便的功能，使得环境的调用更为简单易懂。</p>
</dd>
<dt>具体实现：</dt><dd><p>我们可以很方便地查阅到，<cite>gym.Env</cite> 的 <a class="reference external" href="https://github.com/openai/gym/blob/master/gym/core.py#L8">定义</a> 中，最为关键的部分在于 <code class="docutils literal notranslate"><span class="pre">step</span></code> 和 <code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法。通过给定的 <code class="docutils literal notranslate"><span class="pre">observation</span></code>, <code class="docutils literal notranslate"><span class="pre">step()</span></code> 方法依据输入的 <code class="docutils literal notranslate"><span class="pre">action</span></code> 并与环境产生交互，从而得到相应的 <code class="docutils literal notranslate"><span class="pre">reward</span></code>。 <code class="docutils literal notranslate"><span class="pre">reset()</span></code> 方法则是对环境进行重置。关于环境中的 observation, action, reward，也给出了规范化的定义与限制，分别是 <code class="docutils literal notranslate"><span class="pre">observation_space</span></code> <code class="docutils literal notranslate"><span class="pre">action_space</span></code> 与 <code class="docutils literal notranslate"><span class="pre">reward_range</span></code>。 <cite>ding.envs.BaseEnv</cite> 与 <cite>gym.Env</cite> 类似，除了上述接口与特性外，还定义并实现了：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BaseEnvTimestep(namedtuple)</span></code>：定义了环境每运行一步返回的内容（即 <code class="docutils literal notranslate"><span class="pre">step</span></code> 的返回值），一般包括 <code class="docutils literal notranslate"><span class="pre">obs</span></code> <code class="docutils literal notranslate"><span class="pre">act</span></code> <code class="docutils literal notranslate"><span class="pre">reward</span></code> <code class="docutils literal notranslate"><span class="pre">done</span></code> <code class="docutils literal notranslate"><span class="pre">info</span></code> 五部分，子类可以自定义自己的该变量，但注意必须包含上述五个字段。</p></li>
<li><p>space属性。保留了 <code class="docutils literal notranslate"><span class="pre">observation_space</span></code> 与 <code class="docutils literal notranslate"><span class="pre">action_space</span></code> 的定义，将 <code class="docutils literal notranslate"><span class="pre">reward_range</span></code> 扩展为 <code class="docutils literal notranslate"><span class="pre">reward_space</span></code>，使其与前两个保持一致。如果是多智能体环境，还应当指明 <code class="docutils literal notranslate"><span class="pre">num_agent</span></code>。</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">subprocess_env_manager</span></code> 中 <code class="docutils literal notranslate"><span class="pre">shared_memory</span></code> 强烈依赖 <code class="docutils literal notranslate"><span class="pre">observation_space</span></code> 的实现，如果要使用请务必保证 <code class="docutils literal notranslate"><span class="pre">observation_space</span></code> 的正确性。</p>
</div>
<ol class="arabic simple" start="3">
<li><p><code class="docutils literal notranslate"><span class="pre">create_collector_env_cfg()</span></code>：为数据收集创建相应的环境配置文件，与 <code class="docutils literal notranslate"><span class="pre">create_evaluator_env_cfg</span></code> 互相独立，便于使用者对数据收集和性能评测设置不同的环境参数，根据传入的初始配置为每个具体的环境生成相应的配置文件，默认情况会获取配置文件中的环境个数，然后将默认环境配置复制相应份数返回</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create_evaluator_env_cfg()</span></code>：为性能评测创建相应的环境配置文件，功能同上说明</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">enable_save_replay()</span></code>：使环境可以保存运行过程为视频文件，便于调试和可视化，一般在环境开始实际运行前调用。该方法一半只用于告知环境需要保存 replay 并指定路径。（该方法可选实现）</p></li>
</ol>
<p>此外，<cite>ding.envs.BaseEnv</cite> 还针对细节做了一些改动，例如</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">seed()</span></code>: 对于环境内各种处理函数和 wrapper 的种子控制，外界设定的是种子的种子，当环境用于收集数据时，通常还会区分 <strong>静态种子与动态种子</strong></p></li>
<li><p>默认都使用 <strong>lazy init</strong>，即 init 只设置参数，第一次 reset 时启动环境、设定种子</p></li>
<li><p>episode 结束时，在 <code class="docutils literal notranslate"><span class="pre">BaseEnvTimestep.info</span></code> 这个 dict 中返回 <code class="docutils literal notranslate"><span class="pre">final_eval_reward</span></code> 键值对</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>对于一个环境的具体创建（例如打开其他模拟器客户端），该行为不应该在 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 方法中实现，因为存在创建模型实例但不运行的使用场景（比如获取环境 observation 的维度等信息），推荐在 <code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法中实现，即判断运行环境是否已创建，如果没有则进行创建再 reset，如果有则直接reset已有环境。如果使用者依然想要在 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 方法中完成该功能，请自行确认不会有资源浪费或冲突的情况发生。</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>关于 <code class="docutils literal notranslate"><span class="pre">BaseEnvTimestep</span></code>，如无特殊需求可以直接调用 <cite>DI-engine</cite> 提供的默认定义，即：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ding.envs</span> <span class="kn">import</span> <span class="n">BaseEnvInfo</span>
</pre></div>
</div>
<p>如果需要自定义，按照上文的要求使用 <code class="docutils literal notranslate"><span class="pre">namedtuple(BaseEnvTimestep)</span></code> 实现即可。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="docutils literal notranslate"><span class="pre">seed</span></code> 方法的调用一般在 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 方法之后，<code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法之前。如果将模型的创建放在 <code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法中，则 <code class="docutils literal notranslate"><span class="pre">seed</span></code> 方法只需要记录下这个值，在 <code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法执行时设置随机种子即可。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><cite>DI-engine</cite> 对于环境返回的 <code class="docutils literal notranslate"><span class="pre">BaseEnvTimestep.info</span></code> 字段有一些依赖关系, <code class="docutils literal notranslate"><span class="pre">BaseEnvTimestep.info</span></code> 是一个 dict，其中某些键值对会有相关依赖要求：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">final_eval_reward</span></code>: 环境一个 episode 结束时（ <a href="#id2"><span class="problematic" id="id3">``</span></a>done==True``时 ）必须包含该键值，值为 float 类型，表示环境跑完一个 episode 性能的度量</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">abnormal</span></code>: 环境每个时间步都可包含该键值，该键值非必须，是可选键值，值为 bool 类型，表示环境运行该步是是否发生了错误，如果为真 <cite>DI-engine</cite> 的相关模块会进行相应处理（比如将相关数据移除）。</p></li>
</ol>
</div>
<p>类继承关系如下图所示：</p>
<blockquote>
<div><a class="reference internal image-reference" href="../_images/baseenv_class_uml.png"><img alt="../_images/baseenv_class_uml.png" class="align-center" src="../_images/baseenv_class_uml.png" style="width: 165.6px; height: 262.8px;" /></a>
</div></blockquote>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="collector_overview_zh.html" class="btn btn-neutral float-right" title="Collector Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="algorithm_overview_zh.html" class="btn btn-neutral float-left" title="Algorithm Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, OpenDILab Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>